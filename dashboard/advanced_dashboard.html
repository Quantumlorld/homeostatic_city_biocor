<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Advanced City Control Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 15px;
            padding: 15px;
            height: 100vh;
        }

        .header {
            grid-column: 1 / -1;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online { background: #4CAF50; }
        .status-dot.warning { background: #FF9800; }
        .status-dot.offline { background: #f44336; }

        .left-panel {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }

        .main-panel {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }

        .section {
            margin-bottom: 20px;
        }

        .section h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #64B5F6;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zone-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .zone-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .zone-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .zone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .zone-id {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .zone-state {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .state-calm { background: #4CAF50; }
        .state-overstimulated { background: #FF9800; }
        .state-emergent { background: #f44336; }
        .state-critical { background: #9C27B0; }

        .metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .metric {
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
        }

        .metric-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 2px;
        }

        .chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            height: 300px;
            position: relative;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .control-group select,
        .control-group input {
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .performance-indicator {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }

        .performance-fill {
            height: 100%;
            transition: width 0.5s ease, background-color 0.5s ease;
            border-radius: 4px;
        }

        .ai-prediction {
            background: linear-gradient(135deg, #9C27B0, #673AB7);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .defense-status {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .alert {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid rgba(255, 152, 0, 0.5);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            animation: pulse 2s infinite;
        }

        .alert.critical {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üåç Advanced City Control Dashboard</h1>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot online" id="rust-status"></div>
                    <span>Rust Engine</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="ai-status"></div>
                    <span>AI System</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="defense-status"></div>
                    <span>Defense Systems</span>
                </div>
            </div>
        </div>

        <div class="left-panel">
            <div class="section">
                <h3>üèôÔ∏è City Zones</h3>
                <div class="zone-grid" id="zones-container">
                    <!-- Zone cards will be dynamically inserted -->
                </div>
            </div>

            <div class="section">
                <h3>üß† AI Predictions</h3>
                <div class="ai-prediction" id="ai-predictions">
                    <div>AI Status: <span id="ai-status-text">Initializing...</span></div>
                    <div>Confidence: <span id="ai-confidence">0%</span></div>
                </div>
            </div>
        </div>

        <div class="main-panel">
            <div class="section">
                <h3>üìä Real-time Performance</h3>
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>

            <div class="section">
                <h3>üéõÔ∏è System Controls</h3>
                <div class="controls">
                    <div class="control-group">
                        <label>Target Zone</label>
                        <select id="zone-select">
                            <option value="0">Zone 0</option>
                            <option value="1">Zone 1</option>
                            <option value="2">Zone 2</option>
                            <option value="3">Zone 3</option>
                            <option value="4">Zone 4</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Plant</label>
                        <select id="plant-select">
                            <option value="Ginkgo">Ginkgo</option>
                            <option value="Aloe">Aloe</option>
                            <option value="Turmeric">Turmeric</option>
                            <option value="Ginseng">Ginseng</option>
                            <option value="Ashwagandha">Ashwagandha</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Drug</label>
                        <select id="drug-select">
                            <option value="DrugA">DrugA</option>
                            <option value="DrugB">DrugB</option>
                            <option value="DrugC">DrugC</option>
                            <option value="DrugD">DrugD</option>
                            <option value="DrugE">DrugE</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Synergy</label>
                        <input type="number" id="synergy-input" min="0" max="1" step="0.01" value="0.5">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="applyBioCore()">üåø Apply BioCore</button>
                    <button class="btn btn-warning" onclick="activateAI()">üß† AI Optimize</button>
                    <button class="btn btn-danger" onclick="simulateNuclear()">‚ò¢Ô∏è Test Defense</button>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="section">
                <h3>üõ°Ô∏è Defense Systems</h3>
                <div class="defense-status" id="defense-status-panel">
                    <div>Threat Level: <span id="threat-level">NORMAL</span></div>
                    <div>Radiation: <span id="radiation-level">0.00</span> mSv/h</div>
                </div>
            </div>

            <div class="section">
                <h3>üìà System Metrics</h3>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value" id="avg-activity">0.00</div>
                        <div class="metric-label">Avg Activity</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="response-time">0ms</div>
                        <div class="metric-label">Response Time</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="prediction-accuracy">0%</div>
                        <div class="metric-label">AI Accuracy</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="system-health">100%</div>
                        <div class="metric-label">System Health</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>‚ö° Performance</h3>
                <div>
                    <div>CPU Usage</div>
                    <div class="performance-indicator">
                        <div class="performance-fill" id="cpu-usage" style="width: 20%; background-color: #4CAF50;"></div>
                    </div>
                </div>
                <div>
                    <div>Memory</div>
                    <div class="performance-indicator">
                        <div class="performance-fill" id="memory-usage" style="width: 30%; background-color: #4CAF50;"></div>
                    </div>
                </div>
                <div>
                    <div>Network</div>
                    <div class="performance-indicator">
                        <div class="performance-fill" id="network-usage" style="width: 15%; background-color: #4CAF50;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let zones = [];
        let performanceChart = null;
        let aiPredictions = {};
        let defenseStatus = {};
        
        const API_BASE = 'http://localhost:3030';

        // Initialize dashboard
        async function init() {
            await initializeChart();
            await checkAllSystems();
            await updateDashboard();
            
            // Start real-time updates
            setInterval(updateDashboard, 1000);
            setInterval(updatePerformanceMetrics, 2000);
            setInterval(checkAllSystems, 5000);
        }

        // Initialize performance chart
        async function initializeChart() {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Activity',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'AI Confidence',
                        data: [],
                        borderColor: '#9C27B0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Threat Level',
                        data: [],
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1.0,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'rgba(255,255,255,0.8)' }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'rgba(255,255,255,0.8)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: 'rgba(255,255,255,0.8)' }
                        }
                    }
                }
            });
        }

        // Check all system statuses
        async function checkAllSystems() {
            // Check Rust engine
            const rustStatus = await checkRustEngine();
            updateStatusIndicator('rust-status', rustStatus);
            
            // Check AI system (simulated)
            const aiStatus = Math.random() > 0.1;
            updateStatusIndicator('ai-status', aiStatus);
            
            // Check defense systems (simulated)
            const defenseStatus = Math.random() > 0.05;
            updateStatusIndicator('defense-status', defenseStatus);
        }

        // Check Rust engine health
        async function checkRustEngine() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Update status indicator
        function updateStatusIndicator(elementId, isOnline) {
            const element = document.getElementById(elementId);
            element.className = isOnline ? 'status-dot online' : 'status-dot offline';
        }

        // Update main dashboard
        async function updateDashboard() {
            try {
                const response = await fetch(`${API_BASE}/state`);
                if (!response.ok) return;
                
                zones = await response.json();
                renderZones();
                updateMetrics();
                updateChart();
                
            } catch (error) {
                console.error('Dashboard update failed:', error);
            }
        }

        // Render zone cards
        function renderZones() {
            const container = document.getElementById('zones-container');
            container.innerHTML = '';

            zones.forEach(zone => {
                const card = createZoneCard(zone);
                container.appendChild(card);
            });
        }

        // Create enhanced zone card
        function createZoneCard(zone) {
            const card = document.createElement('div');
            card.className = 'zone-card';
            
            const stateClass = `state-${zone.state.toLowerCase()}`;
            const activityColor = getActivityColor(zone.activity);
            const confidence = aiPredictions[zone.id]?.confidence || 0;
            
            card.innerHTML = `
                <div class="zone-header">
                    <div class="zone-id">Zone ${zone.id}</div>
                    <div class="zone-state ${stateClass}">${zone.state}</div>
                </div>
                <div class="performance-indicator">
                    <div class="performance-fill" style="width: ${zone.activity * 100}%; background-color: ${activityColor};"></div>
                </div>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value">${zone.activity.toFixed(2)}</div>
                        <div class="metric-label">Activity</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${(confidence * 100).toFixed(0)}%</div>
                        <div class="metric-label">AI Confidence</div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Get activity color
        function getActivityColor(activity) {
            if (activity < 0.4) return '#4CAF50';
            if (activity < 0.7) return '#FF9800';
            return '#f44336';
        }

        // Update metrics
        function updateMetrics() {
            const avgActivity = zones.reduce((sum, zone) => sum + zone.activity, 0) / zones.length;
            document.getElementById('avg-activity').textContent = avgActivity.toFixed(2);
            
            // Simulate AI predictions
            zones.forEach(zone => {
                aiPredictions[zone.id] = {
                    confidence: 0.7 + Math.random() * 0.3,
                    prediction: zone.activity + (Math.random() - 0.5) * 0.1
                };
            });
            
            const avgConfidence = Object.values(aiPredictions).reduce((sum, pred) => sum + pred.confidence, 0) / Object.keys(aiPredictions).length;
            document.getElementById('ai-confidence').textContent = `${(avgConfidence * 100).toFixed(0)}%`;
            document.getElementById('ai-status-text').textContent = avgConfidence > 0.8 ? 'Optimized' : 'Learning';
        }

        // Update chart
        function updateChart() {
            if (!performanceChart) return;
            
            const avgActivity = zones.reduce((sum, zone) => sum + zone.activity, 0) / zones.length;
            const avgConfidence = Object.values(aiPredictions).reduce((sum, pred) => sum + pred.confidence, 0) / Object.keys(aiPredictions).length;
            const threatLevel = getThreatLevelNumeric(defenseStatus.threat_level || 'NORMAL');
            
            const now = new Date().toLocaleTimeString();
            
            // Add new data
            performanceChart.data.labels.push(now);
            performanceChart.data.datasets[0].data.push(avgActivity);
            performanceChart.data.datasets[1].data.push(avgConfidence);
            performanceChart.data.datasets[2].data.push(threatLevel);
            
            // Keep only last 20 data points
            if (performanceChart.data.labels.length > 20) {
                performanceChart.data.labels.shift();
                performanceChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            
            performanceChart.update('none');
        }

        // Get threat level numeric
        function getThreatLevelNumeric(threatLevel) {
            const levels = {
                'NORMAL': 0.1,
                'ELEVATED': 0.3,
                'HIGH': 0.5,
                'SEVERE': 0.7,
                'CRITICAL': 0.9
            };
            return levels[threatLevel] || 0.1;
        }

        // Update performance metrics
        function updatePerformanceMetrics() {
            // Simulate performance metrics
            const cpuUsage = 20 + Math.random() * 30;
            const memoryUsage = 30 + Math.random() * 40;
            const networkUsage = 15 + Math.random() * 25;
            const responseTime = 5 + Math.random() * 20;
            const predictionAccuracy = 85 + Math.random() * 10;
            const systemHealth = 90 + Math.random() * 10;
            
            updatePerformanceIndicator('cpu-usage', cpuUsage);
            updatePerformanceIndicator('memory-usage', memoryUsage);
            updatePerformanceIndicator('network-usage', networkUsage);
            
            document.getElementById('response-time').textContent = `${responseTime.toFixed(0)}ms`;
            document.getElementById('prediction-accuracy').textContent = `${predictionAccuracy.toFixed(0)}%`;
            document.getElementById('system-health').textContent = `${systemHealth.toFixed(0)}%`;
        }

        // Update performance indicator
        function updatePerformanceIndicator(elementId, value) {
            const element = document.getElementById(elementId);
            const color = value > 80 ? '#f44336' : value > 60 ? '#FF9800' : '#4CAF50';
            element.style.width = `${value}%`;
            element.style.backgroundColor = color;
        }

        // Apply BioCore effect
        async function applyBioCore() {
            const zoneId = parseInt(document.getElementById('zone-select').value);
            const plant = document.getElementById('plant-select').value;
            const drug = document.getElementById('drug-select').value;
            const synergy = parseFloat(document.getElementById('synergy-input').value);

            try {
                const response = await fetch(`${API_BASE}/biocore`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zone: zoneId, plant, drug, synergy })
                });

                if (response.ok) {
                    showNotification('BioCore effect applied successfully', 'success');
                } else {
                    showNotification('Failed to apply BioCore effect', 'error');
                }
            } catch (error) {
                showNotification('Network error', 'error');
            }
        }

        // Activate AI optimization
        function activateAI() {
            showNotification('AI optimization activated', 'info');
            // Simulate AI optimization
            setTimeout(() => {
                showNotification('AI optimization complete', 'success');
            }, 2000);
        }

        // Simulate nuclear defense test
        function simulateNuclear() {
            showNotification('Defense system test initiated', 'warning');
            defenseStatus = {
                threat_level: 'ELEVATED',
                radiation_level: 0.05 + Math.random() * 0.1
            };
            updateDefenseStatus();
            
            setTimeout(() => {
                defenseStatus = { threat_level: 'NORMAL', radiation_level: 0.0 };
                updateDefenseStatus();
                showNotification('Defense system test complete', 'success');
            }, 5000);
        }

        // Update defense status
        function updateDefenseStatus() {
            document.getElementById('threat-level').textContent = defenseStatus.threat_level || 'NORMAL';
            document.getElementById('radiation-level').textContent = (defenseStatus.radiation_level || 0).toFixed(2);
        }

        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert ${type === 'error' ? 'critical' : ''}`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '1000';
            notification.style.maxWidth = '300px';
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        // Start dashboard
        init();
    </script>
</body>
</html>
